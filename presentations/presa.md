# Как Linux рисует окна?

---

## Вступление

Уже давно в Linux-сообществе ведутся горячие дискуссии о том, когда Wayland заменит Xorg. Однако далеко не все ясно понимают, что из себя представляют эти две технологии.

--

**В этой лекции мы постараемся выяснить:**
1. Что такое Xorg и почему он такой, какой он есть?
2. Почему все его ненавидят?
3. Почему Wayland должен его заменить?

--

**Неизбежно, изучив эту тему подробнее, мы узнаем:**
1. Как современные Linux-дистрибутивы рисуют графический интерфейс? 
2. Как в этом графическом интерфейсе появляются приложения?
3. Почему графика в Linux далеко не такая производительная, как могла бы быть?

---

**На нашем пути познания графики в Linux мы познаем:**

Искусство создания костылей

![](crutch.jpg)

--

Искусство создания плагинов для создания костылей

![](xfixes.png)

--

Искусство сохранения обратной совместимости на протяжении почти половины века

![](xwindowsystem.png)

--

Искусство поддержки и рефакторинга кода, которому почти треть века

![](xfree86.png)

--

Искусство выкидывание легаси-кода на протяжении более 15 лет

![](wayland.png)

--

А также искусство разногласий и лицензионных противоречий

![](packard.png)

---

## Что такое X Window System?

**X Window System** - это оконная система, включающая себя стандартные инструменты и протоколы для построения графического интерфейса пользователя, а также использующаяся в Unix-like системах.

---

## Архитектура X Window System

![](x_architecture.png)

--

**Сервер** - приложение, запущенное на целевом компьютере, который подключен к дисплею и устройствам ввода

Note: 

--

**X-сервер** создаёт на целевом компьютере корневое окно, все остальные окна являются дочерними

--

При этом сам сервер не определяет, каким конкретно образом рисовать окна и оформление для них. Обычно этим занимаются **оконные менеджеры** - программы, работающие поверх X-сервера.

Note: при этом сам сервер не определяет, каким конкретно образом рисовать окна и оформление для них (например, как должны рисоваться заголовки у окон, кнопки сворачивания, разворачивания или закрытия); обычно этим занимаются **оконные менеджеры** - программы, работающие поверх X-сервера; но опять же, обязательства оконных менеджеров по тому, как и что они должны рисовать, нигде не прописаны, поэтому оформление у окон также могут рисовать и сами приложения (в таком случае их внешний вид определяется либо тулкитами, такими как GTK или QT, либо самим разработчиком).

--

**Клиент** - приложение, которое взаимодействует с X-сервером

1. Как правило, это обычное прикладное приложение 
2. При этом клиент может выполняться на удалённой машине и передавать свой интерфейс по сети.

--

Таким образом X Window System основан на клиент-серверной архитектуре, которая была очень удобной в том историческом контексте, в котором X создавался. Однако в будущем это сыграет с ней злую шутку.

![](legacy.png)

Note: Таким образом X Window System основан на клиент-серверной архитектуре и обладает сетевой прозрачностью - неважно, где будет запущен клиент: на той же машине, что сервер, или на другой, будет ли иметь другая машина ту же архитектуру и аппаратное обеспечение или нет. Данная архитектура была очень удобной в том историческом контексте, в котором X создавался. Однако в будущем это сыграет с ней злую шутку.

--

Важной частью X Window System являются **протоколы**, по которому общаются клиент и сервер. Протокол можно сравнить с интерфейсами в ООП или рецептами, по которым мы готовим еду.

![](ramzy.jpg)

Note: Важной частью X Window System являются **протоколы**, по которому общаются клиент и сервер. Протокол можно сравнить с интерфейсами в ООП или рецептами, по которым мы готовим еду. Например, рецепт пирога - это протокол, а уже приготовленный пирог - это реализация. Так же протокол можно сравнить с языком, на котором общаются люди. Язык позволяет доносить информацию другому человеку так, чтобы он её понял. Так же и в X Window System. Клиенты и сервер работают по одному протоколу, что позволяет им понимать друг друга. 

---

![](plura.jpg)

Note: При этом что у клиента, что у сервера существует множество реализаций. В случае с клиентом это очевидно, у нас есть разные приложения, созданные для разных целей и рисующих разный интерфейс, и они реализуют протокол X, чтобы общаться с X-сервером, который позволит им отрисовать то, что им нужно, а так же обработать ввод пользователя, получая команды от X-сервера, так, как им нужно. 

--

### Примеры некоторых реализаций X-сервера:
1. **Xming** - реализация X-сервера для Windows, позволяющая запускать совместимые с X приложения на этой системе
2. **Xquartz** - то же самое, только для MacOS
3. **XFree86** - ранее самая популярная реализация X-сервера для Linux и других Unix-like систем
4. **XOrg** - форк XFree86, сейчас считается канонической реализацией X-сервера

---

## Всё пошло не по плану

![](plan.jpg)
